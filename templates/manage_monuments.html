{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Manage Monuments</h1>
    
    <!-- Add New Monument Button -->
    <button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#addMonumentModal">
        Add New Monument
    </button>
    
    <!-- Monuments Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>City</th>
                    <th>Project</th>
                    <th>Researchers</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for monument in monuments %}
                <tr>
                    <td>{{ monument.MONUMENT_ID }}</td>
                    <td>{{ monument.monument_name }}</td>
                    <td>{{ monument.ITEM_CATEGORY }}</td>
                    <td>{{ monument.city_name }}</td>
                    <td>{{ monument.project_name }}</td>
                    <td>{{ monument.researcher_names or 'None' }}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editMonument({{ monument.MONUMENT_ID }})">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMonument({{ monument.MONUMENT_ID }})">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Monument Modal -->
<div class="modal fade" id="addMonumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Monument</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMonumentForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" name="item_category" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thumbnail URL</label>
                        <input type="url" class="form-control" name="thumbnail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Latitude</label>
                        <input type="number" step="any" class="form-control" name="latitude" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Longitude</label>
                        <input type="number" step="any" class="form-control" name="longitude" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <select class="form-select" name="city_id" required>
                            {% for city in cities %}
                            <option value="{{ city.CITY_ID }}">{{ city.NAME }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Project</label>
                        <select class="form-select" name="excavation_id" required>
                            {% for project in projects %}
                            <option value="{{ project.EXCAVATION_ID }}">{{ project.NAME }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addMonument()">Add Monument</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Monument Modal -->
<div class="modal fade" id="editMonumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Monument</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMonumentForm">
                    <input type="hidden" name="monument_id">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" name="item_category" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thumbnail URL</label>
                        <input type="url" class="form-control" name="thumbnail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Latitude</label>
                        <input type="number" step="any" class="form-control" name="latitude" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Longitude</label>
                        <input type="number" step="any" class="form-control" name="longitude" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <select class="form-select" name="city_id" required>
                            {% for city in cities %}
                            <option value="{{ city.CITY_ID }}">{{ city.NAME }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Project</label>
                        <select class="form-select" name="excavation_id" required>
                            {% for project in projects %}
                            <option value="{{ project.EXCAVATION_ID }}">{{ project.NAME }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMonument()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function addMonument() {
    const form = document.getElementById('addMonumentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/monument', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    });
}

function editMonument(monumentId) {
    const row = document.querySelector(`tr:has(td:first-child:contains('${monumentId}'))`);
    const form = document.getElementById('editMonumentForm');
    
    form.monument_id.value = monumentId;
    form.name.value = row.children[1].textContent;
    form.item_category.value = row.children[2].textContent;
    form.latitude.value = row.children[3].textContent;
    form.longitude.value = row.children[4].textContent;
    form.city_id.value = row.children[5].textContent;
    form.excavation_id.value = row.children[6].textContent;
    
    new bootstrap.Modal(document.getElementById('editMonumentModal')).show();
}

function updateMonument() {
    const form = document.getElementById('editMonumentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/monument', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    });
}

function deleteMonument(monumentId) {
    if (confirm('Are you sure you want to delete this monument?')) {
        fetch('/api/monument', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ monument_id: monumentId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }
}
</script>
{% endblock %} 